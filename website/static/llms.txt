# waveform-playlist

> Multitrack Web Audio editor and player with canvas waveform visualization, built with React and Tone.js.

## What It Does

waveform-playlist is a React component library for building browser-based audio editing applications. It provides:

- Multitrack audio playback, mixing, and editing
- Canvas-based waveform and spectrogram rendering with zoom
- Click-to-seek, drag-to-select, clip drag/trim/split
- 20 real-time audio effects (reverb, delay, EQ, compression, etc.) via Tone.js
- Time-synchronized annotations with drag editing
- Recording with live waveform preview
- WAV export with offline rendering
- BBC audiowaveform support for instant rendering of large files
- Theming via styled-components

## Packages

- `@waveform-playlist/browser` — Main package: React components, hooks, effects
- `@waveform-playlist/core` — Data model: ClipTrack, AudioClip, sample-based math
- `@waveform-playlist/playout` — Audio engine: Tone.js playback, global AudioContext
- `@waveform-playlist/ui-components` — Styled primitives, theming, playhead components, PlaylistErrorBoundary
- `@waveform-playlist/annotations` — Annotation parsing, rendering, keyboard controls
- `@waveform-playlist/recording` — Microphone access, AudioWorklet recording, VU meter, integrated recording hook
- `@waveform-playlist/webaudio-peaks` — Peak extraction from AudioBuffer
- `@waveform-playlist/media-element-playout` — HTMLAudioElement playback with pitch-preserving speed control
- `@waveform-playlist/spectrogram` — Optional spectrogram package: FFT computation, worker-based rendering, color maps, frequency scales. Integrates via `SpectrogramProvider` wrapper

## Quick Start

```tsx
import { WaveformPlaylistProvider, Waveform, PlayButton, PauseButton, StopButton, useAudioTracks } from '@waveform-playlist/browser';

function App() {
  const { tracks, loading } = useAudioTracks([
    { src: '/audio/track1.mp3', name: 'Track 1' },
    { src: '/audio/track2.mp3', name: 'Track 2' },
  ]);

  if (loading) return <div>Loading...</div>;

  return (
    <WaveformPlaylistProvider tracks={tracks} timescale controls={{ show: true, width: 200 }}>
      <PlayButton /> <PauseButton /> <StopButton />
      <Waveform />
    </WaveformPlaylistProvider>
  );
}
```

## Architecture

Both providers use React Context with 4 split contexts for performance.

**WaveformPlaylistProvider** (multi-track, Web Audio API):
1. **usePlaybackAnimation()** — High-frequency: isPlaying, currentTime, timing refs
2. **usePlaylistState()** — Medium-frequency: selection, loop, annotations, settings
3. **usePlaylistControls()** — Stable: play/pause/stop/seekTo, track controls, zoom, settings setters
4. **usePlaylistData()** — Stable: duration, tracks, trackStates, display config, isReady

**MediaElementPlaylistProvider** (single-track, HTMLAudioElement):
1. **useMediaElementAnimation()** — isPlaying, currentTime
2. **useMediaElementState()** — continuousPlay, annotations, playbackRate
3. **useMediaElementControls()** — play/pause/stop/seekTo, setPlaybackRate
4. **useMediaElementData()** — duration, peaksDataArray, sampleRate, display config

## Key Hooks

- `useAudioTracks(configs)` — Load audio files into ClipTrack[] for the provider (declarative, configs-driven)
- `useDynamicTracks()` — Imperative hook for runtime track additions (drag-and-drop, file picker). Creates placeholder tracks instantly while audio decodes in parallel
- `useDynamicEffects()` — Master effects chain with runtime add/remove/parameter updates
- `useTrackDynamicEffects()` — Per-track effects management
- `useClipDragHandlers(opts)` — Drag-to-move and boundary trimming with collision detection
- `useClipSplitting(opts)` — Split clips at playhead position
- `useExportWav()` — Offline WAV export with effects support
- `useKeyboardShortcuts(opts)` — Custom keyboard shortcuts
- `usePlaybackShortcuts(opts)` — Default playback shortcuts (Space, Escape, 0)

### Recording Hooks (from `@waveform-playlist/recording`)

- `useIntegratedRecording(tracks, setTracks, selectedTrackId, options)` — Combined recording + track management: mic access, VU meter, start/stop/pause recording, auto-adds clips to selected track
- `useRecording(stream, options)` — Low-level recording via AudioWorklet with live peaks
- `useMicrophoneAccess()` — Request mic permission, enumerate devices, get MediaStream
- `useMicrophoneLevel(stream)` — Real-time VU meter level from mic stream

## Key Components

- `WaveformPlaylistProvider` — Multi-track provider (Web Audio API / Tone.js). Props: tracks, timescale, controls, theme, effects, annotationList, onAnnotationsChange, onReady, barWidth, barGap, waveHeight, samplesPerPixel, zoomLevels
- `MediaElementPlaylistProvider` — Single-track provider (HTMLAudioElement). Props: track, playbackRate, timescale, controls, theme, annotationList, onAnnotationsChange, onReady, barWidth, barGap, waveHeight, samplesPerPixel. Use for language learning, podcasts, single-track viewers.
- `Waveform` — Main visualization. Props: showClipHeaders, interactiveClips, renderPlayhead, renderTrackControls, showFades, touchOptimized
- Buttons: PlayButton, PauseButton, StopButton, RewindButton, FastForwardButton, LoopButton, SetLoopRegionButton, ZoomInButton, ZoomOutButton, ExportWavButton
- Controls: MasterVolumeControl, TimeFormatSelect, AudioPosition, SelectionTimeInputs, AutomaticScrollCheckbox, ContinuousPlayCheckbox

## Documentation

- Full docs: https://naomiaro.github.io/waveform-playlist/docs/
- LLM API reference: https://naomiaro.github.io/waveform-playlist/docs/api/llm-reference
- Examples: https://naomiaro.github.io/waveform-playlist/docs/examples
- GitHub: https://github.com/naomiaro/waveform-playlist
